<script>
$( init );

jQuery.ajaxSetup({ 
  'beforeSend': function(xhr) {xhr.setRequestHeader("Accept", "text/javascript")}
})

jQuery.fn.submitWithAjax = function() {
  this.submit(function() {
    $.post(this.action, $(this).serialize(), null, "script");
    return false;
  })
  return this;
};

function init() {
	$(".draggable").draggable({
		helper: "clone"
	});
	
	$("#thumbnail").droppable({
        drop: function( event, ui ) {
            thumbnailImage( ui.draggable );
        }
	});
}

function thumbnailImage ($item) {	
	var $list = $("#thumbnail")
	$list.empty();
	$.ajax("images/"+ $item.attr('id') + "/thumbnail")
	
	jQuery('#article_thumbnail_id').val($item.attr("id"));
}

function remove_fields(link) {
  $(link).prev("input[type=hidden]").val("1");
  $(link).closest(".draggable").hide();
}

function add_fields(link, association, content) {
  var new_id = new Date().getTime();
  var regexp = new RegExp("new_" + association, "g")
  $(link).parent().before(content.replace(regexp, new_id));
}
</script>

<style>
.draggable { list-style-type: none; margin: 10px; padding: 0; margin-right: 10px; background: #eee; padding: 5px}

#thumbnail { list-style-type: none; margin: 10px; padding: 0; margin-right: 10px; background: #eee; padding: 5px; width: 304px; height:240px}
</style>

<%= form_for(@article) do |f| %>
	<% if @article.errors.any? %>
		<div id="error_explanation">
			<h2><%= pluralize(@article.errors.count, "error") %> prohibited this article from being saved:</h2>
			<ul>
				<% @article.errors.full_messages.each do |msg| %>
					<li><%= msg %></li>
				<% end %>
			</ul>
		</div>
	<% end %>
	
	<div id="thumbnail">
		<% unless @article.thumbnail_id.nil? then %>
			<%= link_to (image_tag(@article.thumbnail), edit_article_image_path(@article.id, @article.thumbnail_id)) %>
		<% else %>
			<%= image_tag "no-image.jpg"%>
		<% end %>
	</div>

	<div class="field">
		<%= f.label :name %><br />
		<%= f.text_field :name %>
	</div>

	<div class="field">
		<%= f.label :content %><br />
		<%= f.text_area :content %>
	</div>

	<div class="field">
		<%= f.label :category %><br />
		<%= f.text_area :category %>
	</div>
	
	<div class="field">
		<%= f.label "Frontpage?" %>
		<%= f.check_box :frontpage %>
	</div>
	
	<div class="field">
		<%= f.label "Visible?" %>
		<%= f.check_box :visible %>
	</div>
	
	<% for image in @article.images %>
		<div class="field" id='cropwrap'>
	  		<%= image_tag image.photo.url(:small), :class => "draggable", :id => image.id %>
		</div>
	<% end %>
	
	<%= f.fields_for :images do |builder| %>
	    <%= builder.file_field :photo %>
	<% end %>
	
	<%= f.hidden_field :thumbnail_id %>

	<div class="actions">
		<%= f.submit %>
	</div>
	
<% end %>

